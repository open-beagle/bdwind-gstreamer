# WebSocket连接问题修复方案

## 问题描述

系统Web页面显示WebSocket连接不断建立和断开的问题：
```
[10:21:42] WebSocket连接已建立
[10:21:42] WebSocket连接已断开
[10:21:48] WebSocket连接已建立
[10:21:48] WebSocket连接已断开
```

## 问题分析

通过代码分析，发现以下几个可能的问题：

1. **前端重连逻辑过于激进**：WebSocket断开后立即重连，没有考虑断开原因
2. **服务端连接超时设置过短**：读写超时时间过短，导致正常连接被误判为超时
3. **心跳检测频率过高**：ping/pong消息发送过于频繁，增加网络负担
4. **连接清理机制过于严格**：过期连接清理时间过短，活跃连接被误清理

## 修复方案

### 1. 前端连接管理优化

#### 1.1 改进重连逻辑
- **文件**: `internal/webserver/static/signaling.js`
- **修改**: 只在非正常关闭时才重连，避免无限重连循环
- **改进**: 添加最大重连延迟限制，使用指数退避算法

#### 1.2 创建连接管理器
- **文件**: `internal/webserver/static/connection-manager.js` (新增)
- **功能**: 
  - 智能重连机制
  - 心跳检测
  - 连接超时处理
  - 详细的连接状态管理

#### 1.3 更新主应用
- **文件**: `internal/webserver/static/app.js`
- **修改**: 使用新的连接管理器替代原生WebSocket

### 2. 服务端连接处理优化

#### 2.1 调整超时设置
- **文件**: `internal/webrtc/signalingserver.go`
- **修改**: 
  - 读取超时从60秒增加到300秒（5分钟）
  - 写入超时从10秒增加到30秒
  - ping间隔从54秒增加到240秒（4分钟）

#### 2.2 优化连接清理
- **修改**:
  - 过期时间从5分钟增加到10分钟
  - 清理频率从30秒减少到2分钟
  - 清理时发送正常关闭消息而不是强制断开

#### 2.3 改进错误处理
- **修改**: 添加更详细的日志记录，区分正常关闭和异常关闭

### 3. 调试和诊断工具

#### 3.1 WebSocket诊断脚本
- **文件**: `scripts/diagnose_websocket.sh` (新增)
- **功能**:
  - 检查服务状态
  - 测试WebSocket连接
  - 系统资源监控
  - 网络连接分析

#### 3.2 WebSocket测试页面
- **文件**: `internal/webserver/static/websocket-test.html` (新增)
- **功能**:
  - 实时连接测试
  - 消息收发测试
  - 连接统计分析
  - 自动化连接测试

#### 3.3 改进启动脚本
- **文件**: `scripts/start-debug.sh`
- **改进**:
  - 添加服务健康检查
  - 提供故障排除指导
  - 显示诊断工具使用方法

### 4. 配置优化

#### 4.1 调试配置增强
- **文件**: `examples/debug_config.yaml`
- **添加**: WebSocket和WebRTC调试选项

## 使用方法

### 1. 启动服务
```bash
./scripts/start-debug.sh
```

### 2. 运行诊断
```bash
./scripts/diagnose_websocket.sh
```

### 3. 访问测试页面
- 主应用: http://localhost:8080
- WebSocket测试: http://localhost:8080/test/websocket

### 4. 查看日志
```bash
tail -f .tmp/bdwind-gstreamer.log
```

## 预期效果

1. **连接稳定性提升**: WebSocket连接不再频繁断开重连
2. **错误处理改进**: 能够区分正常关闭和异常断开
3. **调试能力增强**: 提供完整的诊断和测试工具
4. **性能优化**: 减少不必要的网络开销

## 故障排除

如果问题仍然存在，请按以下步骤排查：

1. **运行诊断工具**:
   ```bash
   ./scripts/diagnose_websocket.sh
   ```

2. **检查系统资源**: 确保CPU、内存使用率正常

3. **查看详细日志**: 
   ```bash
   tail -f .tmp/bdwind-gstreamer.log | grep -i websocket
   ```

4. **使用测试页面**: 访问 http://localhost:8080/test/websocket 进行连接测试

5. **检查网络环境**: 确保防火墙没有阻止8080端口

## 技术细节

### 连接状态码说明
- `1000`: 正常关闭
- `1001`: 端点离开
- `1006`: 异常关闭
- `1011`: 服务器错误

### 重连策略
- 初始延迟: 2秒
- 最大延迟: 30秒
- 最大重试次数: 5次
- 退避算法: 指数退避

### 心跳机制
- 心跳间隔: 30秒
- 超时检测: 60秒
- 自动恢复: 支持

## 更新日志

- 2024-01-01: 初始版本，修复WebSocket连接不稳定问题
- 添加连接管理器和诊断工具
- 优化服务端超时和清理机制
- 提供完整的测试和调试方案